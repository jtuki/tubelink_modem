# 网关节点固件日志格式说明 #

** 基本格式 **

```
06/23-16:36:40:182 8D.857 *: JD: rx (ACK) <226
06/23-16:37:12:340 1C.561 W: JD: rlc_tx CCA fail >183
```

以第一条日志消息为例。
1. `06/23-16:36:40:182`，是 PC 的本地时间戳。
2. `8D.857`，是单片机的晶振时钟。`8D` 单位是秒（16进制），`857` 单位是毫秒（10进制）。
3. `*`，是日志级别，类似的还有 `W` `E` 等等。
4. 第一个冒号后面的，就是消息本身了。
5. `JD` 表示 joined 已入网状态下的日志消息。类似的还有 `JI` 表示 joining 尝试入网状态下的日志消息。

** Beacon 跟踪 **

作为协议的重要部分，Beacon 跟踪有明确的日志标记。如下。

```
06/23-16:36:59:196 F.439  : JI: @{ (5s:0ms)
06/23-16:37:00:176 10.419  : JI: @} (91)

06/23-16:37:12:105 1C.320  : JD: efe0 @{ (0s:200ms)
06/23-16:37:12:212 1C.411  : JD: @} (97
```

以上。
`@{` 表示开始跟踪 beacon，括号内表示的是跟踪的时间，如 `(5s:0ms)` 表示尝试跟踪（收听） beacon 的时间是五秒，`(0s:200ms)` 表示尝试跟踪（收听） beacon 的时间是200ms。
`@}` 表示跟踪到了 beacon，括号内是 beacon 序列号。

*note*：在已入网场景下，`@{` 标记前的双字节16进制数，如 `efe0`，是节点的短号。

eg. 真实场景下的例子如下。

```
06/23-16:36:43:762 0.015  : init: uuid 3331-3239-3034-4710-1400-3480
06/23-16:36:43:762 0.021  : RRxStop
06/23-16:36:43:762 0.024  : JI: (delay 15s:0ms)
06/23-16:36:59:196 F.439  : JI: @{ (5s:0ms)
06/23-16:36:59:196 F.440  : RRxStart
06/23-16:36:59:537 F.777  : RRead
06/23-16:36:59:537 F.779  : JD: rx not beacon
06/23-16:36:59:716 F.958  : RRead
06/23-16:36:59:716 F.960  : JD: rx not beacon
06/23-16:37:00:175 10.416  : RRead
06/23-16:37:00:176 10.417  : RRxStop
06/23-16:37:00:176 10.419  : JI: @} (91)
06/23-16:37:00:176 10.421  : JI: => joined
```

```
06/23-16:37:12:105 1C.320  : JD: efe0 @{ (0s:200ms)
06/23-16:37:12:106 1C.322  : RRxStart
06/23-16:37:12:177 1C.408  : RRead
06/23-16:37:12:211 1C.409  : RRxStop
06/23-16:37:12:212 1C.411  : JD: @} (97)
```

** 节点数据帧发送 & 网关数据帧确认 **

数据帧发送的日志流程。重要部分摘录如下。其中 `...` 是省略的部分。

```
06/23-16:37:02:080 12.320  : JD: efe0 @{ (0s:200ms)
06/23-16:37:02:187 12.417  : JD: @} (92)
...
06/23-16:37:00:578 10.821  : JD: tx_buf (m_e F28B P16B)
06/23-16:37:02:188 12.421  : JD: rlc_tx (m_e 28B 1T) >179
06/23-16:37:02:188 12.424  : JD: rlc_tx rand_delay (932ms)
06/23-16:37:03:205 13.445  : JD: rlc_tx ok >179
...
06/23-16:37:06:074 16.308  : JD: efe0 @{ (0s:200ms)
06/23-16:37:06:197 16.408  : JD: @} (94)
...
06/23-16:37:06:198 16.409 *: JD: rx (ACK) <179
```

首先的两行是 beacon tracking layer 的日志消息。即，捕获到了序列号是 92 的 beacon。

`tx_buf (m_e F28B P16B)` 表示节点将一条消息放到了上行发送数据的 buffer 队列里。`m_e` 表示消息类型是 `event`，`F28B` 表示 frame 长度是 28 bytes，`P16B` 表示数据帧 payload 是 16 bytes。

`rlc_tx (m_e 28B 1T) >179` 表示将发送一帧长度是 28 bytes 的数据，`1T` 表示是第一次尝试发送（如果发生了一次重传，是 `2T`，两次重传，则是 `3T`，以此类推）；`>179` 表示数据发送的序列号是 179。

由于是在两个 beacon 之后，发送 packed ACK，因此，如果网关在 beacon period 92 里，收到了节点 efe0 的序列号是 179 的消息，就会在 beacon 94 里反馈 ACK。

最后一行日志则记录了这个反馈，即，在 beacon 94（beacon 92 之后的第二个 beacon period）里，收到了 beacon 92 里发送的 179 号消息的 ACK 反馈。

** 网关 packed ACK **

网关会针对来自终端节点的数据帧，给出 ACK 反馈。同一个 beacon period 里收到的数据帧，会在两个 beacon period 之后的 beacon 数据帧的 packed ACK 里给出反馈。
如下的日志，表示网关发送了 -119 号 beacon，同时附带了 6 个ACK。

```
06/23-16:42:25:443 12.024  : gw: beacon(-119) +ACK 6
```

** 文件历史 **
2015-06-29
version: 0.7
author: jtuki@foxmail.com